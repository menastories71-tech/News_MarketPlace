name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          timeout: 300s
          script: |
            set -e
            echo "ðŸš€ Deployment started..."

            #########################################
            # 1. GIT UPDATE
            #########################################
            cd /var/www/news-marketplace

            echo "ðŸ“¥ Pulling latest changes..."
            git fetch --all
            git reset --hard origin/main
            git clean -fd

            #########################################
            # 2. BACKEND SETUP
            #########################################
            echo "ðŸ”§ Installing backend dependencies..."
            cd backend
            npm install --production --legacy-peer-deps

            echo "ðŸ”„ Restarting backend with PM2..."
            pm2 restart news-marketplace-backend || pm2 start server.js --name news-marketplace-backend

            #########################################
            # 3. FRONTEND BUILD
            #########################################
            echo "ðŸŽ¨ Building frontend..."
            cd ../frontend

            rm -rf node_modules package-lock.json
            npm install --legacy-peer-deps
            npm run build

            #########################################
            # 4. DEPLOY DIST FOLDER
            #########################################
            echo "ðŸ“¦ Deploying dist folder..."

            # Your dist files will be served from this location:
            FRONTEND_PATH=/var/www/news-marketplace/dist

            # Remove old build
            rm -rf $FRONTEND_PATH
            mkdir -p $FRONTEND_PATH

            # Copy fresh build
            cp -r dist/* $FRONTEND_PATH/

            #########################################
            # 5. RELOAD NGINX
            #########################################
            echo "ðŸ”„ Reloading nginx..."
            systemctl reload nginx || true

            #########################################
            # 6. FINISH
            #########################################
            echo "ðŸ“Š PM2 Status:"
            pm2 status

            echo "âœ… Deployment completed successfully!"

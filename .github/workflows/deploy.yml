name: Deploy to VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual triggers

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT }}
          timeout: 300s
          script: |
            set -e

            echo "Starting deployment..."

            # Navigate to project directory
            cd /var/www/news-marketplace

            # Pull latest changes
            echo "Pulling latest changes..."
            git fetch --all
            git reset --hard origin/main
            git clean -fd

            # Backend: Install dependencies and restart
            echo "Updating backend..."
            cd backend
            npm ci --production

            # Restart backend with PM2
            echo "Restarting backend..."
            pm2 restart news-marketplace-backend || pm2 start server.js --name news-marketplace-backend

            # Frontend: Install, build, and deploy
            echo "Building frontend..."
            cd ../frontend

            # Clean node_modules to avoid corruption issues
            rm -rf node_modules package-lock.json
            npm install --legacy-peer-deps
            npm run build

            # Ensure build directory has correct ownership
            sudo chown -R deploy:deploy dist/
            sudo chmod -R 755 dist/

            # Copy build files to web server directory (adjust path as needed)
            sudo cp -r dist/* /var/www/html/news-marketplace/

            # Reload nginx to pick up any changes (needs sudo permission)
            echo "Reloading nginx..."
            sudo systemctl reload nginx

            # Show PM2 status
            echo "Deployment complete! PM2 status:"
            pm2 status

            echo "âœ… Deployment successful!"